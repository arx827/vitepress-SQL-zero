<!DOCTYPE html>
<html lang="zh-TW" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第 8 章 SQL 進階處理功能 | 從零開始 邁向數據分析 SQL 資料庫語法入門</title>
    <meta name="description" content="閱讀筆記">
    <link rel="preload stylesheet" href="/vitepress-SQL-zero/assets/style.721c165b.css" as="style">
    <link rel="modulepreload" href="/vitepress-SQL-zero/assets/app.12066fee.js">
    <link rel="modulepreload" href="/vitepress-SQL-zero/assets/guide_chapter_8.md.6e316234.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-93a960b4><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-93a960b4 data-v-790c334c><div class="VPNavBar has-sidebar" data-v-790c334c data-v-eda5fd6f><div class="container" data-v-eda5fd6f><div class="title" data-v-eda5fd6f><div class="VPNavBarTitle has-sidebar" data-v-eda5fd6f data-v-6d2fb2d9><a class="title" href="/vitepress-SQL-zero/" data-v-6d2fb2d9><!--[--><!--]--><!--[--><img class="VPImage logo" src="/vitepress-SQL-zero/apple-touch-icon.png" alt data-v-6db2186b><!--]--><!--[-->從零開始 邁向數據分析 SQL 資料庫語法入門<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-eda5fd6f><div class="curtain" data-v-eda5fd6f></div><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-eda5fd6f data-v-bdedfc22><span id="main-nav-aria-label" class="visually-hidden" data-v-bdedfc22>Main Navigation</span><!--[--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-eda5fd6f data-v-da3f667a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-da3f667a data-v-0d529b6d data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-0d529b6d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-0d529b6d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-eda5fd6f data-v-f38c483a data-v-96001b6b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-96001b6b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-96001b6b><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-96001b6b><div class="VPMenu" data-v-96001b6b data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-f38c483a><div class="item appearance" data-v-f38c483a><p class="label" data-v-f38c483a>Appearance</p><div class="appearance-action" data-v-f38c483a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-f38c483a data-v-0d529b6d data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-0d529b6d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-0d529b6d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-eda5fd6f data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-93a960b4 data-v-2817d72e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2817d72e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-2817d72e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-2817d72e>Menu</span></button><a class="top-link" href="#" data-v-2817d72e>Return to top</a></div><aside class="VPSidebar" data-v-93a960b4 data-v-941101de><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-941101de><span class="visually-hidden" id="sidebar-aria-label" data-v-941101de> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-941101de><section class="VPSidebarGroup" data-v-941101de data-v-c88a18d6><div class="title" data-v-c88a18d6><h2 class="title-text" data-v-c88a18d6>目錄</h2><div class="action" data-v-c88a18d6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-c88a18d6><!--[--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_0.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 0 章 建構 SQL 執行環境</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_1.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 1 章 資料庫與SQL</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_2.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 2 章 查詢的基本語法</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_3.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 3 章 彙總與排序</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_4.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 4 章 更新資料</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_5.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 5 章 進階查詢功能</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_6.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 6 章 函數、述詞、CASE 運算式</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_7.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 7 章 集合運算 (合併查詢)</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/vitepress-SQL-zero/guide/chapter_8.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 8 章 SQL 進階處理功能</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/vitepress-SQL-zero/guide/chapter_9.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>第 9 章 從應用程式連接資料庫</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-93a960b4 data-v-0bd490fb><div class="VPDoc has-sidebar has-aside" data-v-0bd490fb data-v-c5936a1e><div class="container" data-v-c5936a1e><div class="aside" data-v-c5936a1e><div class="aside-curtain" data-v-c5936a1e></div><div class="aside-container" data-v-c5936a1e><div class="aside-content" data-v-c5936a1e><div class="VPDocAside" data-v-c5936a1e data-v-cdc66372><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-cdc66372 data-v-0627715d><div class="content" data-v-0627715d><div class="outline-marker" data-v-0627715d></div><div class="outline-title" data-v-0627715d>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-0627715d><span class="visually-hidden" id="doc-outline-aria-label" data-v-0627715d> Table of Contents for current page </span><ul class="root" data-v-0627715d data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cdc66372></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c5936a1e><div class="content-container" data-v-c5936a1e><!--[--><!--]--><main class="main" data-v-c5936a1e><div style="position:relative;" class="vp-doc _vitepress-SQL-zero_guide_chapter_8" data-v-c5936a1e><div><h1 id="第-8-章-sql-進階處理功能" tabindex="-1">第 8 章 SQL 進階處理功能 <a class="header-anchor" href="#第-8-章-sql-進階處理功能" aria-hidden="true">#</a></h1><h2 id="_8-1-各式各樣的函數" tabindex="-1">8-1 各式各樣的函數 <a class="header-anchor" href="#_8-1-各式各樣的函數" aria-hidden="true">#</a></h2><div class="info custom-block"><p class="custom-block-title">學習重點</p><ul><li>視窗函數能達成加上排名順序或流水編號等，一般彙總函數所做不到的進階操作。</li><li>理解 PARTITION BY 和 ORDER BY 這 2 個關鍵字的意義。</li></ul></div><h3 id="什麼是視窗函數" tabindex="-1">什麼是視窗函數 <a class="header-anchor" href="#什麼是視窗函數" aria-hidden="true">#</a></h3><p><code>視窗函數 (Window Function)</code> 也稱為 <code>OLAP函數</code>。</p><p>所謂 <code>OLAP</code> 是 <code>OnLine Analytical Processing</code> 的簡稱，即為「 <code>線上分析處理</code> 」，意指在使用資料庫的時候，即時完成資料分析的處理工作。例如：市場分析、製作各種財務報表、提出企劃案...等。</p><p>而 <code>視窗函數</code> 正是為了實現 <code>OLAP</code> 的操作方式，添加至 <code>標準 SQL</code> 中的功能。</p><blockquote><h3 id="column-視窗函數的支援現況" tabindex="-1">COLUMN 視窗函數的支援現況 <a class="header-anchor" href="#column-視窗函數的支援現況" aria-hidden="true">#</a></h3><p><code>關聯式資料庫</code> 開始具有這些 <code>OLAP</code> 用途的功能，也不過是最近 10 年左右的事情。 因為是新增加的功能，所以還有一些 <code>DBMS</code> 尚未支援。</p></blockquote><h3 id="視窗函數的語法" tabindex="-1">視窗函數的語法 <a class="header-anchor" href="#視窗函數的語法" aria-hidden="true">#</a></h3><div class="warning custom-block"><p class="custom-block-title">語法 8-1</p><p>視窗函數</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">視窗函數</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> ([PARTITION BY &lt;欄位串列&gt;]</span></span>
<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">排列用欄位串列</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div></div><p>這裡的重點在於 <code>PARTITION BY</code> 以及 <code>ORDER BY</code>，先理解這 2 個關鍵字所扮演的角色，便是理解 <code>視窗函數</code> 的第 1 步。</p><ul><li><h4 id="可做為-視窗函數-使用的函數" tabindex="-1">可做為 <code>視窗函數</code> 使用的函數 <a class="header-anchor" href="#可做為-視窗函數-使用的函數" aria-hidden="true">#</a></h4><p>視窗函數大致上可分為下列 2 種類型：</p><ul><li>① 當作視窗函數使用的彙總函數 (<code>SUM</code>、<code>AVG</code>、<code>COUNT</code>、<code>MAX</code>、<code>MIN</code>)</li><li>② <code>RANK</code>、<code>DENSE_RANK</code>、<code>ROW_NUMBER</code> 等視窗專用函數</li></ul><p>② 是 標準 SQL 為 OLAP 用途所設定的專用函數，統一稱之為「 視窗專用函數 」。</p><p>將 ① 的彙總函數寫在「 語法 8-1 」的 &lt;視窗函數&gt; 位置，便能當作視窗函數來使用。</p></li></ul><h3 id="基本使用方式-以-rank-函數為例" tabindex="-1">基本使用方式 - 以 RANK 函數為例 <a class="header-anchor" href="#基本使用方式-以-rank-函數為例" aria-hidden="true">#</a></h3><p><code>RANK</code> 這個函數，是能對各筆紀錄加上 <code>排名順序 (Ranking)</code> 的函數。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-1</p><p>根據商品分類製作販售單價由小到大的排行榜</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_name, shohin_catalg, sell_price, </span><span style="color:#82AAFF;">RANK</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">PARTITION</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">BY</span><span style="color:#A6ACCD;"> shohin_catalg</span></span>
<span class="line"><span style="color:#A6ACCD;">                                                          </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> ranking</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>shohin_name</th><th>shohin_catalg</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">ranking</th></tr></thead><tbody><tr><td>叉子</td><td>廚房用品</td><td style="text-align:right;">500</td><td style="text-align:right;">1</td></tr><tr><td>刨絲器</td><td>廚房用品</td><td style="text-align:right;">880</td><td style="text-align:right;">2</td></tr><tr><td>菜刀</td><td>廚房用品</td><td style="text-align:right;">3000</td><td style="text-align:right;">3</td></tr><tr><td>壓力鍋</td><td>廚房用品</td><td style="text-align:right;">6800</td><td style="text-align:right;">4</td></tr><tr><td>T恤</td><td>衣物</td><td style="text-align:right;">1000</td><td style="text-align:right;">1</td></tr><tr><td>襯衫</td><td>衣物</td><td style="text-align:right;">4000</td><td style="text-align:right;">2</td></tr><tr><td>鋼珠筆</td><td>辦公用品</td><td style="text-align:right;">100</td><td style="text-align:right;">1</td></tr><tr><td>打孔機</td><td>辦公用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td></tr></tbody></table></div><p><code>PARTITION BY</code> 用來指定加上順位的對象範圍，由於需要在不同商品分類的範圍中，替該商品分類的商品加上名次，所以指定了 <code>shohin_catalg</code>。</p><p><code>ORDER BY</code> 則是用來設定按照哪個欄位，以什麼樣的順序加上名次。因為需要按照販售單價的升冪順序加上名次，所以指定了 <code>sell_price</code> 欄位。可以加上 <code>ASC</code>、<code>DESC</code> 關鍵字來指定升冪或降冪順序。</p><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-1</p><p>視窗函數同時兼具切割分群和賦予順序等 2 種功能。</p></div><p>經過 <code>PARTITION BY</code> 劃分之後所得的紀錄集合稱為「 <code>視窗 (Window)</code> 」，代表「 <code>範圍</code> 」的意思。</p><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-2</p><p><code>PARTITION BY</code> 劃分之後所得的部分集合稱為「 <code>視窗</code> 」。</p></div><h3 id="也可以不指定-partition-by" tabindex="-1">也可以不指定 PARTITION BY <a class="header-anchor" href="#也可以不指定-partition-by" aria-hidden="true">#</a></h3><p><code>PARTITION BY</code> 並非絕對必要的部分，即使不指定 <code>PARTITION BY</code>，便是把整個資料表視為 1 個大型的視窗來處理。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-2</p><p>不指定 PARTITION BY 的寫法</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_name, shohin_catalg, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">RANK</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> ranking</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>shohin_name</th><th>shohin_catalg</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">ranking</th></tr></thead><tbody><tr><td>鋼珠筆</td><td>辦公用品</td><td style="text-align:right;">100</td><td style="text-align:right;">1</td></tr><tr><td>叉子</td><td>廚房用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td></tr><tr><td>打孔機</td><td>辦公用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td></tr><tr><td>刨絲器</td><td>廚房用品</td><td style="text-align:right;">880</td><td style="text-align:right;">4</td></tr><tr><td>T恤</td><td>衣物</td><td style="text-align:right;">1000</td><td style="text-align:right;">5</td></tr><tr><td>菜刀</td><td>廚房用品</td><td style="text-align:right;">3000</td><td style="text-align:right;">6</td></tr><tr><td>襯衫</td><td>衣物</td><td style="text-align:right;">4000</td><td style="text-align:right;">7</td></tr><tr><td>壓力鍋</td><td>廚房用品</td><td style="text-align:right;">6800</td><td style="text-align:right;">8</td></tr></tbody></table><p>此次則變為對資料表中的所有商品一起做排行</p></div><h3 id="常用的視窗專用函數" tabindex="-1">常用的視窗專用函數 <a class="header-anchor" href="#常用的視窗專用函數" aria-hidden="true">#</a></h3><ul><li><h4 id="rank-函數" tabindex="-1">RANK 函數 <a class="header-anchor" href="#rank-函數" aria-hidden="true">#</a></h4><p>計算對象欄位的排行名次，當有多筆紀錄具有相同名次時，後續的名次會按照相同名次的數量順延跳過。</p><p>如： 第 1 名有 3 筆紀錄的狀況：</p><blockquote><p>第 1 名、第 1 名、第 1 名、第 4 名</p></blockquote></li><li><h4 id="dense-rank-函數" tabindex="-1">DENSE_RANK 函數 <a class="header-anchor" href="#dense-rank-函數" aria-hidden="true">#</a></h4><p>同樣是計算排行名次的函數，不過即使有多筆紀錄具有相同的名次，後續的名次也不會跳過處理。</p><p>如： 第 1 名有 3 筆紀錄的狀況：</p><blockquote><p>第 1 名、第 1 名、第 1 名、第 2 名</p></blockquote></li><li><h4 id="row-number-函數" tabindex="-1">ROW_NUMBER 函數 <a class="header-anchor" href="#row-number-函數" aria-hidden="true">#</a></h4><p>替各筆紀錄加上流水編號。</p><p>如： 第 1 名有 3 筆紀錄的狀況：</p><blockquote><p>第 1 名、第 2 名、第 3 名、第 4 名</p></blockquote></li></ul><div class="warning custom-block"><p class="custom-block-title">範例 8-4</p><p>比較 <code>RANK</code>、<code>DENSE_RANK</code>、<code>ROW_NUMBER</code> 的結果</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_name, shohin_catalg, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">RANK</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> ranking</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">DENSE_RANK</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> dense_ranking</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">ROW_NUMBER</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> row_num</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>shohin_name</th><th>shohin_catalg</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">ranking</th><th style="text-align:right;">dense_ranking</th><th style="text-align:right;">row_num</th></tr></thead><tbody><tr><td>鋼珠筆</td><td>辦公用品</td><td style="text-align:right;">100</td><td style="text-align:right;">1</td><td style="text-align:right;">1</td><td style="text-align:right;">1</td></tr><tr><td>叉子</td><td>廚房用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td><td style="text-align:right;">2</td><td style="text-align:right;">2</td></tr><tr><td>打孔機</td><td>辦公用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td><td style="text-align:right;">2</td><td style="text-align:right;">3</td></tr><tr><td>刨絲器</td><td>廚房用品</td><td style="text-align:right;">880</td><td style="text-align:right;">4</td><td style="text-align:right;">3</td><td style="text-align:right;">4</td></tr><tr><td>T恤</td><td>衣物</td><td style="text-align:right;">1000</td><td style="text-align:right;">5</td><td style="text-align:right;">4</td><td style="text-align:right;">5</td></tr><tr><td>菜刀</td><td>廚房用品</td><td style="text-align:right;">3000</td><td style="text-align:right;">6</td><td style="text-align:right;">5</td><td style="text-align:right;">6</td></tr><tr><td>襯衫</td><td>衣物</td><td style="text-align:right;">4000</td><td style="text-align:right;">7</td><td style="text-align:right;">6</td><td style="text-align:right;">7</td></tr><tr><td>壓力鍋</td><td>廚房用品</td><td style="text-align:right;">6800</td><td style="text-align:right;">8</td><td style="text-align:right;">7</td><td style="text-align:right;">8</td></tr></tbody></table></div><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-3</p><p>由於視窗專用函數不會引用參數，所以括號()中，不需填入任何東西。</p></div><h3 id="視窗函數應當寫在何處" tabindex="-1">視窗函數應當寫在何處 <a class="header-anchor" href="#視窗函數應當寫在何處" aria-hidden="true">#</a></h3><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-4</p><p>視窗函數原則上僅能寫在 <code>SELECT 子句</code> 之中。</p></div><p>理由在於 <code>DBMS</code> 內部的執行方式，因為視窗函數在運作上，便是針對 <code>WHERE 子句</code> 或 <code>GROUP BY 子句</code> 處理後所獲得的「 <code>中間結果</code> 」產生作用。例如在名次排列完成之後，如果又因為 <code>WHERE 子句</code> 的條件而減少紀錄筆數、或是 <code>GROUP BY 子句</code> 的作用而再進行彙總統計，那麼先前的排行結果當然會發生問題。</p><h3 id="將彙總函數當作視窗函數使用" tabindex="-1">將彙總函數當作視窗函數使用 <a class="header-anchor" href="#將彙總函數當作視窗函數使用" aria-hidden="true">#</a></h3><p>所有的彙總函數都可以當作視窗函數使用，在這種使用方式之下，其語法和使用視窗函數的時候完全相同。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-4</p><p>將 SUM 函數當作視窗函數使用</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code>、</li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_id, shohin_name, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> shohin_id) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> current_sum</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th style="text-align:right;">shohin_id</th><th>shohin_name</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">current_sum</th></tr></thead><tbody><tr><td style="text-align:right;">0001</td><td>T恤</td><td style="text-align:right;">1000</td><td style="text-align:right;">1000</td></tr><tr><td style="text-align:right;">0002</td><td>打孔機</td><td style="text-align:right;">500</td><td style="text-align:right;">1500</td></tr><tr><td style="text-align:right;">0003</td><td>襯衫</td><td style="text-align:right;">4000</td><td style="text-align:right;">5500</td></tr><tr><td style="text-align:right;">0004</td><td>菜刀</td><td style="text-align:right;">3000</td><td style="text-align:right;">8500</td></tr><tr><td style="text-align:right;">0005</td><td>壓力鍋</td><td style="text-align:right;">6800</td><td style="text-align:right;">15300</td></tr><tr><td style="text-align:right;">0006</td><td>叉子</td><td style="text-align:right;">500</td><td style="text-align:right;">15800</td></tr><tr><td style="text-align:right;">0007</td><td>刨絲器</td><td style="text-align:right;">880</td><td style="text-align:right;">16680</td></tr><tr><td style="text-align:right;">0008</td><td>鋼珠筆</td><td style="text-align:right;">100</td><td style="text-align:right;">16780</td></tr></tbody></table><ul><li>0001 -&gt; 1000</li><li>0002 -&gt; 1000 + 500</li><li>0003 -&gt; 1000 + 500 + 4000</li></ul></div><p>使用 <code>SUM 函數</code> 的時候不同於 <code>RANK</code> 或 <code>ROW_NUMBER</code>，需要在 <code>()括號</code> 中填入參數，和之前學過的使用方式一樣，應當指定統計對象的欄位名稱。</p><p>不過這並非單純的總計值，而是先利用 <code>ORDER BY 子句</code>，指定紀錄按照 <code>shohin_id</code> 由小到大排列之後，再計算商品ID「 <code>比自己還小</code> 」的商品販售單價總計，每往下一行紀錄，計算總計的對象紀錄也會增加 1 筆，而這樣的統計方式，通常稱為「 <code>累計</code> 」。實務上也經常按照時間的順序，計算各段時間營業金額的累計數字。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-5</p><p>將 AVG 函數當作視窗函數使用</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code>、</li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_id, shohin_name, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">AVG</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> shohin_id) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> current_avg</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th style="text-align:right;">shohin_id</th><th>shohin_name</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">current_sum</th></tr></thead><tbody><tr><td style="text-align:right;">0001</td><td>T恤</td><td style="text-align:right;">1000</td><td style="text-align:right;">1000.0000000000000000</td></tr><tr><td style="text-align:right;">0002</td><td>打孔機</td><td style="text-align:right;">500</td><td style="text-align:right;">750.0000000000000000</td></tr><tr><td style="text-align:right;">0003</td><td>襯衫</td><td style="text-align:right;">4000</td><td style="text-align:right;">1833.3333333333333333</td></tr><tr><td style="text-align:right;">0004</td><td>菜刀</td><td style="text-align:right;">3000</td><td style="text-align:right;">2125.0000000000000000</td></tr><tr><td style="text-align:right;">0005</td><td>壓力鍋</td><td style="text-align:right;">6800</td><td style="text-align:right;">3060.0000000000000000</td></tr><tr><td style="text-align:right;">0006</td><td>叉子</td><td style="text-align:right;">500</td><td style="text-align:right;">2633.3333333333333333</td></tr><tr><td style="text-align:right;">0007</td><td>刨絲器</td><td style="text-align:right;">880</td><td style="text-align:right;">2382.8571428571428571</td></tr><tr><td style="text-align:right;">0008</td><td>鋼珠筆</td><td style="text-align:right;">100</td><td style="text-align:right;">2097.5000000000000000</td></tr></tbody></table><ul><li>0001 -&gt; (1000) / 1</li><li>0002 -&gt; (1000 + 500) / 2</li><li>0003 -&gt; (1000 + 500 + 4000) / 3</li></ul></div><p>觀察執行的結果，應該可以看出 <code>current_avg</code> 是計算販售單價的平均值，不過統計的對象只有包含「 <code>自身上方</code> 」的紀錄。</p><p>像這樣以「 自身紀錄 (<code>當前紀錄</code>) 」為基準來決定統計對象的特點，便是將彙總函數當作視窗函數使用時的一大特色。</p><h3 id="計算移動平均" tabindex="-1">計算移動平均 <a class="header-anchor" href="#計算移動平均" aria-hidden="true">#</a></h3><p><code>視窗函數</code> 在執行的時候，會先從資料表切割出名為 <code>視窗</code> 的部分資料集合，然後進行附加順序的動作，不過對於視窗之中的資料，其實還有額外的選項功能，可以進一步指定更加精細的統計範圍，而這樣更精細的統計範圍被稱做「 <code>窗格(Frame)</code> 」。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-6</p><p>設定統計對象為「 最近 3 筆紀錄 」</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code>、</li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_id, shohin_name, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">AVG</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> shohin_id </span><span style="color:#F78C6C;">ROWS</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">PRECEDING</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> moving_avg</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th style="text-align:right;">shohin_id</th><th>shohin_name</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">moving_avg</th></tr></thead><tbody><tr><td style="text-align:right;">0001</td><td>T恤</td><td style="text-align:right;">1000</td><td style="text-align:right;">1000</td></tr><tr><td style="text-align:right;">0002</td><td>打孔機</td><td style="text-align:right;">500</td><td style="text-align:right;">750</td></tr><tr><td style="text-align:right;">0003</td><td>襯衫</td><td style="text-align:right;">4000</td><td style="text-align:right;">1833</td></tr><tr><td style="text-align:right;">0004</td><td>菜刀</td><td style="text-align:right;">3000</td><td style="text-align:right;">2500</td></tr><tr><td style="text-align:right;">0005</td><td>壓力鍋</td><td style="text-align:right;">6800</td><td style="text-align:right;">4600</td></tr><tr><td style="text-align:right;">0006</td><td>叉子</td><td style="text-align:right;">500</td><td style="text-align:right;">3433</td></tr><tr><td style="text-align:right;">0007</td><td>刨絲器</td><td style="text-align:right;">880</td><td style="text-align:right;">2726</td></tr><tr><td style="text-align:right;">0008</td><td>鋼珠筆</td><td style="text-align:right;">100</td><td style="text-align:right;">493</td></tr></tbody></table><ul><li>0001 -&gt; (1000) / 1</li><li>0002 -&gt; (1000 + 500) / 2</li><li>0003 -&gt; (1000 + 500 + 4000) / 3</li><li>0004 -&gt; (500 + 4000 + 3000) / 3</li><li>0005 -&gt; (4000 + 3000 + 6800) / 3</li></ul></div><ul><li><h4 id="指定窗格-統計範圍" tabindex="-1">指定窗格 (統計範圍) <a class="header-anchor" href="#指定窗格-統計範圍" aria-hidden="true">#</a></h4><p>這裡使用了 <code>ROWS (橫行、紀錄)</code> 以及 <code>PRECEDING (之前的)</code> 這 2 個關鍵字，設定出「 <code>包含前 ～ 筆紀錄</code> 」的窗格，以「 <code>ROWS 2 PRECEDING</code> 」的寫法，指定「 <code>包含前 2 筆紀錄</code> 」的窗格，將統計對象限制在下列的「 <code>最近 3 筆紀錄</code> 」。</p><ul><li>自身 (當前紀錄)</li><li>自身前 1 行的紀錄</li><li>自身前 2 行的紀錄</li></ul><p>藉由當前紀錄的位置，以相對的方式決定窗格的範圍，所以和視窗的固定範圍不同，目前的 <code>當前紀錄</code> 不同時，納入統計的範圍也會發生改變。</p><p>這樣的統計方式稱為 <code>移動平均 (Moving Average)</code>，由於對於想要時常掌握「 <code>最近的狀況</code> 」來說相當方便，所以經常應用於追蹤股價趨勢之類的場合。</p><p>另外，若改以 <code>FOLLOWING (之後的)</code> 這個關鍵字取代 <code>PRECEDING</code>，便能指定「 包含後 ～ 筆紀錄 」的窗格範圍。</p></li><li><h4 id="將當前紀錄前後的紀錄都納入統計對象" tabindex="-1">將當前紀錄前後的紀錄都納入統計對象 <a class="header-anchor" href="#將當前紀錄前後的紀錄都納入統計對象" aria-hidden="true">#</a></h4><p>如果想更進一步，讓當前紀錄前後的紀錄同時成為統計的對象，可以合併使用 <code>PRECEDING (之前的)</code> 以及 <code>FOLLOWING (之後的)</code> 這 2 個關鍵字。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-7</p><p>將當前紀錄前後的紀錄都納入統計對象</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code>、</li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_id, shohin_name, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">AVG</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> shohin_id</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#F78C6C;">ROWS</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">BETWEEN</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">PRECEDING</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FOLLOWING</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> moving_avg</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th style="text-align:right;">shohin_id</th><th>shohin_name</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">moving_avg</th></tr></thead><tbody><tr><td style="text-align:right;">0001</td><td>T恤</td><td style="text-align:right;">1000</td><td style="text-align:right;">750</td></tr><tr><td style="text-align:right;">0002</td><td>打孔機</td><td style="text-align:right;">500</td><td style="text-align:right;">1833</td></tr><tr><td style="text-align:right;">0003</td><td>襯衫</td><td style="text-align:right;">4000</td><td style="text-align:right;">2500</td></tr><tr><td style="text-align:right;">0004</td><td>菜刀</td><td style="text-align:right;">3000</td><td style="text-align:right;">4600</td></tr><tr><td style="text-align:right;">0005</td><td>壓力鍋</td><td style="text-align:right;">6800</td><td style="text-align:right;">3433</td></tr><tr><td style="text-align:right;">0006</td><td>叉子</td><td style="text-align:right;">500</td><td style="text-align:right;">2726</td></tr><tr><td style="text-align:right;">0007</td><td>刨絲器</td><td style="text-align:right;">880</td><td style="text-align:right;">493</td></tr><tr><td style="text-align:right;">0008</td><td>鋼珠筆</td><td style="text-align:right;">100</td><td style="text-align:right;">490</td></tr></tbody></table><ul><li>0001 -&gt; (1000 + 500) / 2</li><li>0002 -&gt; (1000 + 500 + 4000) / 3</li><li>0003 -&gt; (500 + 4000 + 3000) / 3</li><li>0004 -&gt; (4000 + 3000 + 6800) / 3</li><li>0005 -&gt; (3000 + 6800 + 500) / 3</li></ul></div><p>這樣的窗格指定方式，代表以「 <code>1 PRECEDING</code> 」(前 1 筆紀錄) 至「 <code>1 FOLLOWING</code> 」(後 1 筆紀錄) 為統計對象，具體來說便是下列的 3 筆紀錄。</p><ul><li>自身前 1 行的紀錄</li><li>自身 (當前紀錄)</li><li>自身後 1 行的紀錄</li></ul><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-5</p><p>把 <code>彙總函數</code> 當 <code>視窗函數</code> 使用的時候，可以用 <code>當前紀錄為基準</code> 來決定統計對象紀錄。</p></div></li></ul><h3 id="_2個-order-by" tabindex="-1">2個 ORDER BY <a class="header-anchor" href="#_2個-order-by" aria-hidden="true">#</a></h3><p><code>OVER 子句</code> 中 <code>ORDER BY</code> 的功能，充其量只能決定 <code>視窗函數</code> 應該以哪個欄位的順序執行運算，所以並不會影響到最終結果的排序。</p><p>雖然有些 <code>DBMS</code> 所顯示的結果，會按照 <code>視窗函數</code> 後面的 <code>ORDER BY 子句</code> 所指定的欄位來排序，不過這屬於開發商自行增加的功能。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-8</p><p>無法保證此段 SELECT 敘述執行結果的排列順序</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_name, shohin_catalg, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">RANK</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> ranking</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>shohin_name</th><th>shohin_catalg</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">ranking</th></tr></thead><tbody><tr><td>菜刀</td><td>廚房用品</td><td style="text-align:right;">3000</td><td style="text-align:right;">6</td></tr><tr><td>打孔機</td><td>辦公用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td></tr><tr><td>襯衫</td><td>衣物</td><td style="text-align:right;">4000</td><td style="text-align:right;">7</td></tr><tr><td>T恤</td><td>衣物</td><td style="text-align:right;">1000</td><td style="text-align:right;">5</td></tr><tr><td>壓力鍋</td><td>廚房用品</td><td style="text-align:right;">6800</td><td style="text-align:right;">8</td></tr><tr><td>叉子</td><td>廚房用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td></tr><tr><td>刨絲器</td><td>廚房用品</td><td style="text-align:right;">880</td><td style="text-align:right;">4</td></tr><tr><td>鋼珠筆</td><td>廚房用品</td><td style="text-align:right;">100</td><td style="text-align:right;">1</td></tr></tbody></table></div><p>如果想讓各筆紀錄確實按照 <code>ranking</code> 欄位由小到大排列的話，只需在 <code>SELECT 敘述</code> 的最後，再加上 1 個 <code>ORDER BY 子句</code> 指定排序的欄位即可。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-9</p><ul><li>專用語法：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>PostgreSQL</code>、<code>MariaDB 10.2 之後</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_name, shohin_catalg, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">RANK</span><span style="color:#A6ACCD;">() </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> ranking</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> ranking;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>shohin_name</th><th>shohin_catalg</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">ranking</th></tr></thead><tbody><tr><td>鋼珠筆</td><td>廚房用品</td><td style="text-align:right;">100</td><td style="text-align:right;">1</td></tr><tr><td>打孔機</td><td>辦公用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td></tr><tr><td>叉子</td><td>廚房用品</td><td style="text-align:right;">500</td><td style="text-align:right;">2</td></tr><tr><td>刨絲器</td><td>廚房用品</td><td style="text-align:right;">880</td><td style="text-align:right;">4</td></tr><tr><td>T恤</td><td>衣物</td><td style="text-align:right;">1000</td><td style="text-align:right;">5</td></tr><tr><td>菜刀</td><td>廚房用品</td><td style="text-align:right;">3000</td><td style="text-align:right;">6</td></tr><tr><td>襯衫</td><td>衣物</td><td style="text-align:right;">4000</td><td style="text-align:right;">7</td></tr><tr><td>壓力鍋</td><td>廚房用品</td><td style="text-align:right;">6800</td><td style="text-align:right;">8</td></tr></tbody></table></div><h2 id="_8-2-grouping-運算子" tabindex="-1">8-2 GROUPING 運算子 <a class="header-anchor" href="#_8-2-grouping-運算子" aria-hidden="true">#</a></h2><div class="info custom-block"><p class="custom-block-title">學習重點</p><ul><li>光靠 <code>GROUP BY 子句</code> 以及 <code>彙總函數</code>，無法同時求得小計和總計的數字，而能達成此目的的功能便是 <code>GROUPING 運算子</code>。</li><li>理解 <code>GROUPING 運算子</code> <code>CUBE</code> 功能的關鍵，在於想像它是「 以積木疊成的立方體 」。</li><li>雖然 <code>GROUPING 運算子</code> 屬於 標準SQL 的功能，不過還有部分的 <code>DBMS</code> 無法使用。</li></ul></div><h3 id="一併列出總計行" tabindex="-1">一併列出總計行 <a class="header-anchor" href="#一併列出總計行" aria-hidden="true">#</a></h3><div class="warning custom-block"><p class="custom-block-title">範例 8-10</p><p>以 GROUP BY 子句 無法列出總計的紀錄</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_catalg, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price)</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> shohin_catalg;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>shohin_catalg</th><th style="text-align:right;">sum</th></tr></thead><tbody><tr><td>衣物</td><td style="text-align:right;">5000</td></tr><tr><td>辦公用品</td><td style="text-align:right;">600</td></tr><tr><td>廚房用品</td><td style="text-align:right;">11180</td></tr></tbody></table></div><p>由於 <code>GROUP BY 子句</code> 是用來指定做為彙總鍵的欄位，敘述執行時只會按照其中指定的彙總鍵來分割資料表，所以不會出現總計紀錄。</p><p>如果想達成這樣的需求，可以先分別求得總計行、以及按照牤品分類進行統計的結果，然後再 <code>UNION ALL</code> 將2者串連在一起。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-11</p><p>分別求得 總計行 和 彙總結果，再以 UNION ALL 串聯</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">合計</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> shohin_catalg, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price)</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">UNION ALL</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_catalg, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price)</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> shohin_catalg;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>shohin_catalg</th><th style="text-align:right;">sum</th></tr></thead><tbody><tr><td>合計</td><td style="text-align:right;">16780</td></tr><tr><td>衣物</td><td style="text-align:right;">5000</td></tr><tr><td>辦公用品</td><td style="text-align:right;">600</td></tr><tr><td>廚房用品</td><td style="text-align:right;">11180</td></tr></tbody></table></div><p>雖然這樣也能獲得想要的結果，不過要先執行 2 段幾乎相同的 <code>SELECT 敘述</code>，然後再將結果串連輸出，不僅敘述看起來相當冗長，也會耗費更多 <code>DBMS</code> 內部處理的效能。</p><h3 id="rollup-1次取得總計與小計" tabindex="-1">ROLLUP - 1次取得總計與小計 <a class="header-anchor" href="#rollup-1次取得總計與小計" aria-hidden="true">#</a></h3><ul><li><h4 id="grouping-運算子-有以下-3-類。" tabindex="-1"><code>GROUPING 運算子</code> 有以下 3 類。 <a class="header-anchor" href="#grouping-運算子-有以下-3-類。" aria-hidden="true">#</a></h4><ul><li><code>ROLLUP</code></li><li><code>CUBE</code></li><li><code>GROUPING SETS</code></li></ul></li><li><h4 id="rollup-的使用方式" tabindex="-1">ROLLUP 的使用方式 <a class="header-anchor" href="#rollup-的使用方式" aria-hidden="true">#</a></h4><p>只要使用此運算子的功能，即可簡單寫出能一併列出總計行的 <code>SELECT 敘述</code>。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-12</p><p>以 ROLLUP 同時列出總計與小計</p><ul><li>專用語法：<code>Oracle</code>、<code>DB2</code>、<code>SQL Server</code>、<code>PostgreSQL</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_catalg, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ROLLUP</span><span style="color:#A6ACCD;">(shohin_catalg);</span></span>
<span class="line"></span></code></pre></div><p>執行結果 (DB2 的狀況)</p><table><thead><tr><th>shohin_catalg</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td></td><td style="text-align:right;">16780</td></tr><tr><td>廚房用品</td><td style="text-align:right;">11180</td></tr><tr><td>辦公用品</td><td style="text-align:right;">600</td></tr><tr><td>衣物</td><td style="text-align:right;">5000</td></tr></tbody></table></div><div class="warning custom-block"><p class="custom-block-title">專用語法：<code>MySQL</code>、<code>MariaDB</code></p><p>在 <code>MySQL</code> 和 <code>MariaDB</code> 上執行 範例 8-12 的敘述時，需要將「 <code>GROUP BY ROLLUP(shohin_catalg)</code> 」的 <code>GROUP BY 子句</code> 部分改為 「 <code>GROUP BY shohin_catalg WITH ROLLUP</code> 」。</p><p><code>MariaDB 10.2.4</code> 的 <code>ROLLUP</code> 寫法和 <code>MySQL</code> 相同。</p></div><p>在語法上，對於 <code>GROUP BY 子句</code> 的彙總鍵串列部分，可以寫成「 <code>ROLLUP(&lt;欄位1&gt;, &lt;欄位2&gt;, ...)</code> 」的形式。而假若要以 1 句話簡單說明此 <code>ROLLUP 演算法</code> 的功用，可以說「 <code>同時計算出彙總鍵在不同組合下的結果</code> 」。</p><p>上面的範例，便是一併算出下列 2 種組合方式的統計結果。</p><ul><li><code>GROUP BY ()</code> 相當於未指定彙總鍵，在這種狀況下會產生所有單價總和的總計行，而此總計列的紀錄稱為 <code>超級集合列 (Supergroup Row)</code>。只要理解到這是原本 <code>GROUP BY 子句</code> 所無法產生的總計列即可。</li><li><code>GROUP BY (shohin_catalg)</code></li></ul><p>由於對於 <code>DBMS</code> 來說是未知的鍵值，所以使用預設的 <code>NULL</code>，後面再解說如何改成填入適當的字串。</p><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-6</p><p>超級集合列。</p></div></li><li><h4 id="在彙總鍵中增加「-登錄日期-」的例子" tabindex="-1">在彙總鍵中增加「 登錄日期 」的例子 <a class="header-anchor" href="#在彙總鍵中增加「-登錄日期-」的例子" aria-hidden="true">#</a></h4><div class="warning custom-block"><p class="custom-block-title">範例 8-13</p><p>在 GROUP BY 增加「 登錄日期 」的例子 (無 ROLLUP)</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_catalg, reg_date, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> shohin_catalg, reg_date;</span></span>
<span class="line"></span></code></pre></div><p>執行結果 (DB2 的狀況)</p><table><thead><tr><th>shohin_catalg</th><th>reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td>廚房用品</td><td>2008-04-28</td><td style="text-align:right;">880</td></tr><tr><td>廚房用品</td><td>2009-01-15</td><td style="text-align:right;">6800</td></tr><tr><td>廚房用品</td><td>2009-09-20</td><td style="text-align:right;">3500</td></tr><tr><td>辦公用品</td><td>2009-09-11</td><td style="text-align:right;">500</td></tr><tr><td>辦公用品</td><td>2009-11-11</td><td style="text-align:right;">100</td></tr><tr><td>衣物</td><td>2009-09-20</td><td style="text-align:right;">1000</td></tr><tr><td>衣物</td><td></td><td style="text-align:right;">4000</td></tr></tbody></table></div><div class="warning custom-block"><p class="custom-block-title">範例 8-14</p><p>在 GROUP BY 增加「 登錄日期 」的例子 (有 ROLLUP)</p><ul><li>專用語法：<code>Oracle</code>、<code>DB2</code>、<code>SQL Server</code>、<code>PostgreSQL</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_catalg, reg_date, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ROLLUP</span><span style="color:#A6ACCD;">(shohin_catalg, reg_date);</span></span>
<span class="line"></span></code></pre></div><p>執行結果 (DB2 的狀況)</p><table><thead><tr><th>shohin_catalg</th><th>reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td></td><td></td><td style="text-align:right;">16780</td></tr><tr><td>廚房用品</td><td></td><td style="text-align:right;">11180</td></tr><tr><td>廚房用品</td><td>2008-04-28</td><td style="text-align:right;">880</td></tr><tr><td>廚房用品</td><td>2009-01-15</td><td style="text-align:right;">6800</td></tr><tr><td>廚房用品</td><td>2009-09-20</td><td style="text-align:right;">3500</td></tr><tr><td>辦公用品</td><td></td><td style="text-align:right;">600</td></tr><tr><td>辦公用品</td><td>2009-09-11</td><td style="text-align:right;">500</td></tr><tr><td>辦公用品</td><td>2009-11-11</td><td style="text-align:right;">100</td></tr><tr><td>衣物</td><td></td><td style="text-align:right;">5000</td></tr><tr><td>衣物</td><td>2009-09-20</td><td style="text-align:right;">1000</td></tr><tr><td>衣物</td><td></td><td style="text-align:right;">4000</td></tr></tbody></table></div><div class="warning custom-block"><p class="custom-block-title">專用語法：<code>MySQL</code>、<code>MariaDB</code></p><p>在 <code>MySQL</code> 和 <code>MariaDB</code> 上執行 範例 8-14 的敘述時，需要將「 <code>GROUP BY ROLLUP(shohin_catalg, reg_date)</code> 」的 <code>GROUP BY 子句</code> 部分改為 「 <code>GROUP BY shohin_catalg, reg_date WITH ROLLUP</code> 」。</p></div><p>加上 <code>ROLLUP</code> 之後的寫法，其結果多了最上方所有商品的總計列，以及 3 種商品分類個別的小計列 (也就是當作彙總鍵中沒有登錄日期的結果紀錄)，這 4 列紀錄均屬於 <code>超級集合列</code>。</p><p>此 <code>SELECT 敘述</code> 的結果，相當於先執行下列 3 種模式的彙總層級，再以 <code>UNION</code> 串聯輸出結果。</p><ul><li><code>GROUP BY ()</code></li><li><code>GROUP BY (shohin_catalg)</code></li><li><code>GROUP BY (shohin_catalg, reg_date)</code></li></ul><p><code>ROLLUP</code> 具有從最小範圍的彙總統計層級開始，按照小計到總計的順序，逐漸擴展彙總統計的單位，其名稱便是根據這樣的意象而命名。</p><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-7</p><p><code>ROLLUP</code> 是能同時獲得總計與小計的方便工具。</p></div></li></ul><blockquote><h3 id="column-grouping-運算子的支援現況" tabindex="-1">COLUMN GROUPING 運算子的支援現況 <a class="header-anchor" href="#column-grouping-運算子的支援現況" aria-hidden="true">#</a></h3><p><code>GROUPING 運算子</code> 和 <code>視窗函數</code>，算是比較新的項目 (增加這些功能的標準SQL版本為：SQL:1999)，因此，還有一些 <code>DBMS</code> 尚未支援相關語法。最新版的 <code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code> 以及 <code>PostgreSQL</code> 已經能完全支援，不過 <code>MySQL 5.7</code> 和 <code>MariaDB 10.2</code> 還無法使用。</p><p>在尚未支援 <code>GROUPING 運算子</code> 和 <code>DBMS</code> 上，想要以 <code>SQL 敘述</code> 同樣獲得包含總計和小計的結果時，只能採用舊有方法，將多段 <code>SELECT 敘述</code> 以 <code>UNION</code> 串聯輸出最後的結果。</p><p>另外，<code>MySQL</code> 和 <code>MariaDB</code> 的狀況又稍微有些複雜，只能使用變形過後的 <code>ROLLUP 語法</code>。</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- MySQL、MariaDB</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_catalg, reg_date, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> shohin_catalg, reg_date </span><span style="color:#F78C6C;">WITH</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ROLLUP</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span></code></pre></div><p><code>MySQL</code>、<code>MariaDB</code> 目前暫時無法支援 <code>CUBE</code> 和 <code>GROUPING SETS</code>。</p></blockquote><h3 id="grouping函數-分辨-null-的真偽" tabindex="-1">GROUPING函數 - 分辨 NULL 的真偽 <a class="header-anchor" href="#grouping函數-分辨-null-的真偽" aria-hidden="true">#</a></h3><p>在前個單元 <code>ROLLUP</code> 的執行結果中，出現了 2 筆 <code>reg_date</code> 欄位為 <code>NULL</code> 的紀錄。</p><p><code>sum_price</code> 為 4000 元的這筆資料，在來源的資料表中，由於襯衫的登陸日期為 <code>NULL</code>，這裡照實列出了原本的 NULL。</p><p><code>sum_price</code> 為 5000 元的這筆資料，則應該是 <code>超級集合列</code> 的 <code>NULL</code>，不過這 2 者外觀上都是以 <code>NULL</code> 的形式呈現。</p><table><thead><tr><th>shohin_catalg</th><th>reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td>衣物</td><td></td><td style="text-align:right;">5000</td></tr><tr><td>衣物</td><td>2009-09-20</td><td style="text-align:right;">1000</td></tr><tr><td>衣物</td><td></td><td style="text-align:right;">4000</td></tr></tbody></table><p>為了防止混亂狀況，<code>SQL</code> 特別準備了 <code>GROUPING 函數</code>，用來判別是否為 <code>超級集合列</code> 的 <code>NULL</code>。如果寫入其參數位置的欄位內容值為 <code>超級集合列</code> 的 <code>NULL</code> 時，此函數會回傳 <code>1</code>，而其他的內容值則會回傳 <code>0</code>。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-15</p><p>利用 GROUPING 函數判別 NULL</p><ul><li>專用語法：<code>Oracle</code>、<code>DB2</code>、<code>SQL Server</code>、<code>PostgreSQL</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(shohin_catalg) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> shohin_catalg,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(reg_date) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> reg_date,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ROLLUP</span><span style="color:#A6ACCD;">(shohin_catalg, reg_date);</span></span>
<span class="line"></span></code></pre></div><p>執行結果 (DB2 的狀況)</p><table><thead><tr><th style="text-align:right;">shohin_catalg</th><th style="text-align:right;">reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td style="text-align:right;">1</td><td style="text-align:right;">1</td><td style="text-align:right;">16780</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">1</td><td style="text-align:right;">11180</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">0</td><td style="text-align:right;">880</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">0</td><td style="text-align:right;">6800</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">0</td><td style="text-align:right;">3500</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">1</td><td style="text-align:right;">600</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">0</td><td style="text-align:right;">500</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">0</td><td style="text-align:right;">100</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">1</td><td style="text-align:right;">5000</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">0</td><td style="text-align:right;">1000</td></tr><tr><td style="text-align:right;">0</td><td style="text-align:right;">0</td><td style="text-align:right;">4000</td></tr></tbody></table></div><p>若能善加利用 <code>GROUPING 函數</code> 的功能，還能進一步在 <code>超級集合列</code> 的彙總鍵欄位內容內，填入適當的文字。其基本原理為當 <code>GROUPING 函數</code> 的回傳值為 1 的時候，指定顯示「 總計 」或「 小計 」之類的自訂文字，而其他回傳值則保持原始資料的內容值。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-16</p><p>將超級集合列的鍵值改為適當的字串</p><ul><li>專用語法：<code>Oracle</code>、<code>DB2</code>、<code>SQL Server</code>、<code>PostgreSQL</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">CASE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHEN</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(shohin_catalg) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">THEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品分類 總計</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">ELSE</span><span style="color:#A6ACCD;"> shohin_catalg </span><span style="color:#F78C6C;">END</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> shohin_catalg,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">CASE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHEN</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(reg_date) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">THEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">登錄日期 總計</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">ELSE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CAST</span><span style="color:#A6ACCD;">(reg_date </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">)) </span><span style="color:#F78C6C;">END</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> reg_date,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ROLLUP</span><span style="color:#A6ACCD;">(shohin_catalg, reg_date);</span></span>
<span class="line"></span></code></pre></div><p>執行結果 (DB2 的狀況)</p><table><thead><tr><th>shohin_catalg</th><th style="text-align:right;">reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td>商品分類 總計</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">16780</td></tr><tr><td>廚房用品</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">11180</td></tr><tr><td>廚房用品</td><td style="text-align:right;">2008-04-28</td><td style="text-align:right;">880</td></tr><tr><td>廚房用品</td><td style="text-align:right;">2009-01-15</td><td style="text-align:right;">6800</td></tr><tr><td>廚房用品</td><td style="text-align:right;">2009-09-20</td><td style="text-align:right;">3500</td></tr><tr><td>辦公用品</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">600</td></tr><tr><td>辦公用品</td><td style="text-align:right;">2009-09-11</td><td style="text-align:right;">500</td></tr><tr><td>辦公用品</td><td style="text-align:right;">2009-11-11</td><td style="text-align:right;">100</td></tr><tr><td>衣物</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">5000</td></tr><tr><td>衣物</td><td style="text-align:right;">2009-09-20</td><td style="text-align:right;">1000</td></tr><tr><td>衣物</td><td style="text-align:right;"></td><td style="text-align:right;">4000</td></tr></tbody></table></div><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">CAST</span><span style="color:#A6ACCD;">(reg_date </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">))</span></span>
<span class="line"></span></code></pre></div><p>將 <code>reg_date</code> 欄位轉換成字串型別，是因為 <code>CASE 運算式</code> 所有分支處理的回傳值，其型別必須完全一致，上面的型別轉換措施，便是為了符合這樣的規則。如果沒有加上這個動作，執行時將會造成語法錯誤。</p><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-8</p><p>使用 <code>GROUPING 函數</code>，即可簡單區分出原始資料的 <code>NULL</code> 和 <code>超級集合列</code> 的 <code>NULL</code>。</p></div><h3 id="cube-將資料堆疊成積木" tabindex="-1">CUBE - 將資料堆疊成積木 <a class="header-anchor" href="#cube-將資料堆疊成積木" aria-hidden="true">#</a></h3><p>CUBE 運算子，此英文單字代表了「 立方體 」的意思。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-17</p><p>以 CUBE 取得所有可能的組合</p><ul><li>專用語法：<code>Oracle</code>、<code>DB2</code>、<code>SQL Server</code>、<code>PostgreSQL</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">CASE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHEN</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(shohin_catalg) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">THEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品分類 總計</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">ELSE</span><span style="color:#A6ACCD;"> shohin_catalg </span><span style="color:#F78C6C;">END</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> shohin_catalg,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">CASE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHEN</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(reg_date) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">THEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">登錄日期 總計</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">ELSE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CAST</span><span style="color:#A6ACCD;">(reg_date </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">)) </span><span style="color:#F78C6C;">END</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> reg_date,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">CUBE</span><span style="color:#A6ACCD;">(shohin_catalg, reg_date);</span></span>
<span class="line"></span></code></pre></div><p>執行結果 (DB2 的狀況)</p><table><thead><tr><th>shohin_catalg</th><th style="text-align:right;">reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td>商品分類 總計</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">16780</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2008-04-28</td><td style="text-align:right;">880</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-01-15</td><td style="text-align:right;">6800</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-09-11</td><td style="text-align:right;">500</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-09-20</td><td style="text-align:right;">4500</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-11-11</td><td style="text-align:right;">100</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;"></td><td style="text-align:right;">4000</td></tr><tr><td>廚房用品</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">11180</td></tr><tr><td>廚房用品</td><td style="text-align:right;">2008-04-28</td><td style="text-align:right;">880</td></tr><tr><td>廚房用品</td><td style="text-align:right;">2009-01-15</td><td style="text-align:right;">6800</td></tr><tr><td>廚房用品</td><td style="text-align:right;">2009-09-20</td><td style="text-align:right;">3500</td></tr><tr><td>辦公用品</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">600</td></tr><tr><td>辦公用品</td><td style="text-align:right;">2009-09-11</td><td style="text-align:right;">500</td></tr><tr><td>辦公用品</td><td style="text-align:right;">2009-11-11</td><td style="text-align:right;">100</td></tr><tr><td>衣物</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">5000</td></tr><tr><td>衣物</td><td style="text-align:right;">2009-09-20</td><td style="text-align:right;">1000</td></tr><tr><td>衣物</td><td style="text-align:right;"></td><td style="text-align:right;">4000</td></tr></tbody></table></div><p>對比 <code>ROLLUP</code> 的結果，<code>CUBE</code> 執行之後會再多出幾行紀錄，觀察新增加的紀錄即可得知，這是在僅使用 <code>reg_date</code> 當作彙總鍵的狀況下新增加的紀錄。</p><ul><li><code>GROUP BY ()</code></li><li><code>GROUP BY (shohin_catalg)</code></li><li><code>GROUP BY (reg_date)</code></li><li><code>GROUP BY (shohin_catalg, reg_date)</code></li></ul><p><code>CUBE</code> 的功能是針對 <code>GROUP BY 子句</code> 中所寫入的彙總鍵，將「 <code>所有可能的組合方式</code> 」的結果，如同大雜燴一般同時輸出。</p><div class="tip custom-block"><p class="custom-block-title">牢記的原則 8-9</p><p>可以將 <code>CUBE</code> 理解成先利用彙總鍵切割資料區塊，然後再堆疊成立方體的樣貌。</p></div><h3 id="grouping-sets-只取出部分積木" tabindex="-1">GROUPING SETS - 只取出部分積木 <a class="header-anchor" href="#grouping-sets-只取出部分積木" aria-hidden="true">#</a></h3><p>對於 <code>ROLLUP</code> 或 <code>CUBE</code> 所獲得的結果，如果只需要其中的部分紀錄時，便可使用此運算子。</p><div class="warning custom-block"><p class="custom-block-title">範例 8-18</p><p>以 CUBE 取得所有可能的組合</p><ul><li>專用語法：<code>Oracle</code>、<code>DB2</code>、<code>SQL Server</code>、<code>PostgreSQL</code></li></ul><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">CASE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHEN</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(shohin_catalg) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">THEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品分類 總計</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">ELSE</span><span style="color:#A6ACCD;"> shohin_catalg </span><span style="color:#F78C6C;">END</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> shohin_catalg,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">CASE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHEN</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">GROUPING</span><span style="color:#A6ACCD;">(reg_date) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">THEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">登錄日期 總計</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">ELSE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CAST</span><span style="color:#A6ACCD;">(reg_date </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">)) </span><span style="color:#F78C6C;">END</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> reg_date,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> GROUPING </span><span style="color:#F78C6C;">SETS</span><span style="color:#A6ACCD;"> (shohin_catalg, reg_date);</span></span>
<span class="line"></span></code></pre></div><p>執行結果 (DB2 的狀況)</p><table><thead><tr><th>shohin_catalg</th><th style="text-align:right;">reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td>商品分類 總計</td><td style="text-align:right;">2008-04-28</td><td style="text-align:right;">880</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-01-15</td><td style="text-align:right;">6800</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-09-11</td><td style="text-align:right;">500</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-09-20</td><td style="text-align:right;">4500</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;">2009-11-11</td><td style="text-align:right;">100</td></tr><tr><td>商品分類 總計</td><td style="text-align:right;"></td><td style="text-align:right;">4000</td></tr><tr><td>廚房用品</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">11180</td></tr><tr><td>辦公用品</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">600</td></tr><tr><td>衣物</td><td style="text-align:right;">登錄日期 總計</td><td style="text-align:right;">5000</td></tr></tbody></table></div><p>在此結果當中，已經沒有全部商品的總計行 (16780 元)。像這樣相對於 <code>ROLLUP</code> 或 <code>CUBE</code> 在執行後會獲得有規律的、比較符合日常業務所需的資料，<code>GROUPING SETS</code> 則會指定個別的單獨條件，從中抽出較為特殊的部分結果。</p><h2 id="自我練習" tabindex="-1">自我練習 <a class="header-anchor" href="#自我練習" aria-hidden="true">#</a></h2><ul><li><p>8.1 如果對章節內文所使用過的 Shohin (商品) 資料表，執行如下所示的 <code>SELECT 敘述</code>，請預測一下將會得到什麼樣的結果。</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_id, shohin_name, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">MAX</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> shohin_id) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> current_max_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div><details class="details custom-block"><summary>練習</summary><table><thead><tr><th>shohin_id</th><th>shohin_name</th><th style="text-align:right;">sell_price</th><th style="text-align:right;">current_max_price</th></tr></thead><tbody><tr><td>0001</td><td>T恤</td><td style="text-align:right;">1000</td><td style="text-align:right;">1000</td></tr><tr><td>0002</td><td>打孔機</td><td style="text-align:right;">500</td><td style="text-align:right;">1000</td></tr><tr><td>0003</td><td>襯衫</td><td style="text-align:right;">4000</td><td style="text-align:right;">4000</td></tr><tr><td>0004</td><td>菜刀</td><td style="text-align:right;">3000</td><td style="text-align:right;">4000</td></tr><tr><td>0005</td><td>壓力鍋</td><td style="text-align:right;">6800</td><td style="text-align:right;">6800</td></tr><tr><td>0006</td><td>叉子</td><td style="text-align:right;">500</td><td style="text-align:right;">6800</td></tr><tr><td>0007</td><td>刨絲器</td><td style="text-align:right;">880</td><td style="text-align:right;">6800</td></tr><tr><td>0008</td><td>鋼珠筆</td><td style="text-align:right;">100</td><td style="text-align:right;">6800</td></tr></tbody></table><p><code>OVER</code> 中 缺少了 <code>PARTITION BY 子句</code> 來限制比較範圍。使 <code>current_max_price</code> 未依分類比較。</p><p>應改為：</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> shohin_id, shohin_name, sell_price,</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#82AAFF;">MAX</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">OVER</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">PARTITION</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">BY</span><span style="color:#A6ACCD;"> shohin_catalg</span></span>
<span class="line"><span style="color:#A6ACCD;">                             </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> shohin_id) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> current_max_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin;</span></span>
<span class="line"></span></code></pre></div></details></li><li><p>8.2 接下來同樣使用 Shohin 資料表，在按照 <code>登錄日期</code> 將紀錄由小到大排列的狀況下，請同時求得各日期時間點上 <code>販售單價 (sell_price)</code> 的 總計金額。不過登錄日期為 <code>NULL</code> 的「 襯衫 」這筆紀錄必須排在 <code>第 1 行</code> 的位置 (也就是早於其他商品的登錄日期)。</p><details class="details custom-block"><summary>練習</summary><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> reg_date, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(sell_price) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> sum_price</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> Shohin</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> reg_date</span></span>
<span class="line"><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> reg_date;</span></span>
<span class="line"></span></code></pre></div><p>執行結果</p><table><thead><tr><th>reg_date</th><th style="text-align:right;">sum_price</th></tr></thead><tbody><tr><td></td><td style="text-align:right;">4000</td></tr><tr><td>2008-04-28</td><td style="text-align:right;">880</td></tr><tr><td>2009-01-15</td><td style="text-align:right;">6800</td></tr><tr><td>2009-09-11</td><td style="text-align:right;">500</td></tr><tr><td>2009-09-20</td><td style="text-align:right;">4500</td></tr><tr><td>2009-11-11</td><td style="text-align:right;">100</td></tr></tbody></table></details></li></ul></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-c5936a1e data-v-e033cd21><!----><div class="prev-next" data-v-e033cd21><div class="pager" data-v-e033cd21><a class="pager-link prev" href="/vitepress-SQL-zero/guide/chapter_7.html" data-v-e033cd21><span class="desc" data-v-e033cd21>Previous page</span><span class="title" data-v-e033cd21>第 7 章 集合運算 (合併查詢)</span></a></div><div class="has-prev pager" data-v-e033cd21><a class="pager-link next" href="/vitepress-SQL-zero/guide/chapter_9.html" data-v-e033cd21><span class="desc" data-v-e033cd21>Next page</span><span class="title" data-v-e033cd21>第 9 章 從應用程式連接資料庫</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-93a960b4 data-v-d24360a6><div class="container" data-v-d24360a6><!----><p class="copyright" data-v-d24360a6>MIT Lincensed | Copyright © 2023-present Eason</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"guide_chapter_0.md\":\"de036069\",\"guide_chapter_1.md\":\"ca727084\",\"guide_chapter_2.md\":\"a4eb522b\",\"guide_chapter_3.md\":\"4a9ef05f\",\"guide_chapter_5.md\":\"3d608a90\",\"guide_chapter_4.md\":\"443483c4\",\"index.md\":\"04c6d6e3\",\"guide_chapter_8.md\":\"6e316234\",\"guide_chapter_9.md\":\"9c9f9594\",\"guide_chapter_7.md\":\"dbd1dc90\",\"guide_chapter_6.md\":\"fdc0f91d\"}")</script>
    <script type="module" async src="/vitepress-SQL-zero/assets/app.12066fee.js"></script>
    
  </body>
</html>